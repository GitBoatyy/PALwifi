<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PALwifi Logger Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #fafbfc;}
    #container { max-width: 900px; margin: 32px auto; background: #fff; padding: 24px 32px; border-radius: 12px; box-shadow: 0 2px 6px #0001; }
    h1 { font-weight: 700; }
    .row { display: flex; align-items: center; margin-bottom: 1em; }
    .row label { margin-right: 8px; }
    #linkmap { margin-left: auto; }
    canvas { margin-bottom: 32px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 24px;}
    th, td { padding: 4px 8px; border: 1px solid #eee; }
    th { background: #f0f2f4;}
  </style>
</head>
<body>
  <div id="container">
    <h1>PALwifi Logger Analytics</h1>
    <div class="row">
      <label for="unitSelect">Select Unit:</label>
      <select id="unitSelect"></select>
      <a href="map.html" id="linkmap">View Map &raquo;</a>
    </div>
    <canvas id="wifiChart"></canvas>
    <canvas id="internetChart"></canvas>
    <div>
      <h3>Recent Data (last 20 samples)</h3>
      <table id="datatable"></table>
    </div>
  </div>
  <script>
    const units = [
      'Palantir', 'Palantir2', 'Palantir3', 'Palantir4', 'Palantir5', 'Palantir6'
    ];
    const unitSelect = document.getElementById('unitSelect');
    units.forEach(u => {
      let opt = document.createElement('option');
      opt.value = u;
      opt.text = u;
      unitSelect.add(opt);
    });

    // Chart objects
    let wifiChart, internetChart;
    let wifiChartCtx = document.getElementById('wifiChart').getContext('2d');
    let internetChartCtx = document.getElementById('internetChart').getContext('2d');

    function loadAndPlot(unit) {
      fetch(`data/${unit}_parsed.csv`)
        .then(resp => resp.text())
        .then(csv => {
          // Parse CSV
          let rows = csv.trim().split('\n');
          let headers = rows[0].split(',');
          let data = rows.slice(1).map(row => {
            let values = row.split(',');
            let o = {};
            headers.forEach((h, i) => { o[h.trim()] = values[i]; });
            return o;
          }).filter(o => o['Date'] && o['Time']); // filter blank lines

          // Extract fields for charting
          let labels = data.map(o => `${o['Date']} ${o['Time']}`);
          let wifiVals = data.map(o => Number(o['Wifi'] || o['WIFI'] || 0));
          let intVals = data.map(o => Number(o['Int'] || o['INT'] || 0));

          // Destroy existing charts if any
          if (wifiChart) wifiChart.destroy();
          if (internetChart) internetChart.destroy();

          // Wi-Fi chart
          wifiChart = new Chart(wifiChartCtx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Wi-Fi Connected',
                data: wifiVals,
                backgroundColor: 'rgba(0,180,0,0.15)',
                borderColor: 'rgba(0,150,0,0.7)',
                pointRadius: 2,
                fill: true,
                stepped: true,
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false }},
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, callback: v=>v ? 'Yes':'No' } }
              }
            }
          });

          // Internet chart
          internetChart = new Chart(internetChartCtx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Internet Connectivity',
                data: intVals,
                backgroundColor: 'rgba(0,0,180,0.15)',
                borderColor: 'rgba(0,0,180,0.6)',
                pointRadius: 2,
                fill: true,
                stepped: true,
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false }},
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1, callback: v=>v ? 'Yes':'No' } }
              }
            }
          });

          // Table: show last 20 rows
          let tbl = document.getElementById('datatable');
          tbl.innerHTML = '';
          let cols = ['Date','Time','SSID','Wifi','Int','Discrete2','Latitude','Longitude','Altitude'];
          let thead = document.createElement('tr');
          cols.forEach(c => { let th=document.createElement('th'); th.textContent=c; thead.appendChild(th); });
          tbl.appendChild(thead);
          data.slice(-20).forEach(row => {
            let tr = document.createElement('tr');
            cols.forEach(c => { let td=document.createElement('td'); td.textContent=row[c]||''; tr.appendChild(td); });
            tbl.appendChild(tr);
          });
        });
    }

    // Initial load
    loadAndPlot(unitSelect.value);
    unitSelect.addEventListener('change', () => {
      loadAndPlot(unitSelect.value);
    });
  </script>
</body>
</html>
