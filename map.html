<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PALwifi Logger Map</title>
  <link rel="stylesheet" href="css/leaflet.css"/>
  <script src="js/leaflet.js"></script>
  <style>
    body { margin:0; background: #fafbfc; }
    #navbar { background: #164778; color: #fff; padding: 0 24px; height: 48px; display: flex; align-items: center; }
    #navbar a {
      color: #fff; text-decoration: none; margin-right: 18px; font-weight: 600; font-size: 1.1em; padding: 6px 12px;
      border-radius: 6px; transition: background 0.2s;
    }
    #navbar a:hover, #navbar a.active { background: #2362a1; }
    #container { max-width: 1080px; margin: 32px auto; background: #fff; padding: 24px 32px; border-radius: 12px; box-shadow: 0 2px 6px #0001; }
    h1 { font-weight: 700; }
    #controls { display: flex; align-items: center; gap: 18px; margin-bottom: 14px; }
    #map { width: 100%; height: 600px; border-radius: 12px; border: 1px solid #ddd; margin: 0 auto;}
    #unitSelect, #filterSelect { font-size: 1.05em; padding: 4px 12px;}
  </style>
</head>
<body>
  <nav id="navbar">
    <a href="index.html" id="nav_dashboard">Dashboard</a>
    <a href="map.html" class="active" id="nav_map">Map</a>
    <a href="#" id="nav_home">Home</a>
  </nav>
  <div id="container">
    <h1>PALwifi Logger Map</h1>
    <div id="controls">
      <label for="unitSelect">Select Unit:</label>
      <select id="unitSelect"></select>
      <label for="filterSelect">Filter:</label>
      <select id="filterSelect">
        <option value="wifi">Wi-Fi Connectivity</option>
        <option value="internet">Internet Connectivity (on ground)</option>
      </select>
    </div>
    <div id="map"></div>
  </div>
  <script>
    // Hardcoded units
    const units = [
      'Palantir',
      'Palantir2',
      'Palantir3',
      'Palantir4',
      'Palantir5',
      'Palantir6',
      'Palantir7'
    ];
    const unitSelect = document.getElementById('unitSelect');
    units.forEach(u => {
      let opt = document.createElement('option');
      opt.value = u; opt.text = u;
      unitSelect.add(opt);
    });

    // Navbar logic
    document.getElementById('nav_dashboard').onclick = ()=>{window.location='index.html';};
    document.getElementById('nav_home').onclick = (e)=>{
      e.preventDefault();
      alert('Welcome to PALwifi! Use Dashboard or Map.');
    };

    // Map
    let map = L.map('map').setView([49.9, -119.5], 10); // Centered on Kelowna
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let markersLayer = L.layerGroup().addTo(map);

    // Filter logic
    const filterSelect = document.getElementById('filterSelect');

    function loadAndPlot(unit) {
      markersLayer.clearLayers();
      fetch(`data/${unit}_map.json`)
        .then(resp => resp.json())
        .then(points => {
          let count = 0;
          let filter = filterSelect.value;
          points.forEach(p => {
            let lat = parseFloat(p.Latitude || p.lat);
            let lon = parseFloat(p.Longitude || p.lon || p.lng);
            if (!isNaN(lat) && !isNaN(lon)) {
              // Filtering logic
              let wifi = (p.Wifi ?? p.WIFI ?? p.wifi) == 1 ? 1 : 0;
              let inet = (p.Int ?? p.INT ?? p.int) == 1 ? 1 : 0;
              let discrete2 = (p.Discrete2 !== undefined) ? parseInt(p.Discrete2) : 1;
              let show = true;
              let color = 'gray';
              if (filter === 'wifi') {
                color = wifi ? 'green' : 'red';
              } else if (filter === 'internet') {
                // Show only when Discrete2 == 1 (on ground)
                if (discrete2 === 1) {
                  color = inet ? 'green' : 'red';
                } else {
                  show = false;
                }
              }
              if (!show) return;
              let marker = L.circleMarker([lat, lon], {
                radius: 6,
                fillColor: color,
                color: "#111",
                weight: 1,
                fillOpacity: 0.8
              }).addTo(markersLayer);
              let popup = `
                <b>${unit}</b><br>
                Time: ${p.Date || ''} ${p.Time || ''}<br>
                SSID: ${p.SSID || ''}<br>
                Wifi: ${wifi ? "Yes" : "No"}<br>
                Internet: ${inet ? "Yes" : "No"}<br>
                Lat: ${lat}<br>
                Lon: ${lon}
              `;
              marker.bindPopup(popup);
              count++;
            }
          });
          if (count > 0) {
            // Center map on first valid point
            let first = points.find(p => !isNaN(parseFloat(p.Latitude)) && !isNaN(parseFloat(p.Longitude)));
            if(first) map.setView([parseFloat(first.Latitude), parseFloat(first.Longitude)], 11);
          }
        });
    }

    // Initial load
    loadAndPlot(units[0]);
    unitSelect.addEventListener('change', ()=> loadAndPlot(unitSelect.value));
    filterSelect.addEventListener('change', ()=> loadAndPlot(unitSelect.value));
  </script>
</body>
</html>
